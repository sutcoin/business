<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SUT 업체 제출</title>
  <style>
    body{font-family:system-ui, "Noto Sans KR", sans-serif; padding:18px; background:#f6f8fb; color:#222}
    .card{max-width:920px;margin:18px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
    h2{color:#0b74de;margin:0 0 8px 0}
    label{display:block;margin-top:12px;font-weight:600}
    input, textarea, button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
    .small{font-size:13px;color:#666}
    .files input{width:100%}
    .preview-grid{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
    .preview{width:150px;border-radius:8px;padding:8px;background:#fafafa;border:1px solid #eee;box-sizing:border-box;text-align:center}
    .preview img{max-width:100%;height:auto;border-radius:6px}
    .meta{font-size:12px;color:#555;margin-top:6px}
    .status{margin-top:12px;font-size:14px}
    .progress{height:10px;background:#eee;border-radius:10px;overflow:hidden;margin-top:8px}
    .bar{height:100%;width:0;background:#0b74de}
    button.primary{background:#0b74de;color:#fff;border:0;font-weight:700;cursor:pointer;padding:12px;border-radius:8px}
    button.primary[disabled]{opacity:0.6;cursor:not-allowed}
    .note{margin-top:10px;font-size:13px;color:#444}
  </style>
</head>
<body>
  <div class="card">
    <h2>업체 정보 제출</h2>
    <p class="small">이미지 자동 최적화 기능이 포함되어 있습니다. (최대 5장)</p>

    <form id="businessForm" action="#" method="POST" enctype="multipart/form-data" onsubmit="return false;">
      <!-- 전송 대상은 Formsubmit.co (아래 JS에서 XHR로 전송) -->
      <input type="hidden" name="_next" value="https://google.com" />
      <input type="hidden" name="_captcha" value="false" />

      <label>업체명 *</label>
      <input id="business_name" name="업체명" required maxlength="100" />

      <label>주소지 *</label>
      <input id="address" name="주소지" required />

      <label>전화번호 *</label>
      <input id="phone" name="전화번호" type="tel" required placeholder="예: 010-1234-5678" />

      <label>SUT 할인율 (%) *</label>
      <input id="discount" name="SUT_할인율" type="number" step="0.01" min="0" max="100" required />

      <label>네이버지도 링크 *</label>
      <input id="navermap" name="네이버지도링크" type="url" required placeholder="https://map.naver.com/..." />

      <label>업체홍보 사진 (최대 5장)</label>
      <div class="files">
        <input id="photos" type="file" accept="image/*" multiple />
      </div>
      <div class="small">자동 리사이즈: 최대 1200px(가로/세로) → JPEG 압축(용량 최적화). 파일당 목표 최대 3MB.</div>

      <div id="preview" class="preview-grid" aria-live="polite"></div>

      <label>업체 소개 *</label>
      <textarea id="description" name="업체소개" rows="6" required></textarea>

      <label>가게 홍보 태그</label>
      <input id="tags" name="홍보태그" placeholder="#카페, #브런치" />

      <div class="status" id="statusArea"></div>

      <div class="progress" id="progressWrap" style="display:none"><div class="bar" id="progressBar"></div></div>

      <button id="submitBtn" class="primary" type="button">제출하기</button>
    </form>

    <p class="note">주의: Formsubmit은 첫 사용 시 수신자(choieuisin@naver.com)에서 활성화 메일을 클릭해야 정상 수신됩니다.</p>
  </div>

<script>
/*
  이미지 최적화 + 제출 스크립트
  - 최대 이미지 수: 5
  - 리사이즈 최대 치수: 1200px
  - 목표 압축 최대 파일 사이즈: 3MB (품질을 낮춰 재시도)
  - 최소 품질: 0.4
  - 전송은 XMLHttpRequest (진행률 표시 가능)
  - 전송 대상: https://formsubmit.co/choieuisin@naver.com
*/

const MAX_FILES = 5;
const MAX_DIM = 1200;            // 최대 가로/세로 픽셀
const TARGET_SIZE = 3 * 1024*1024; // 3MB
const MIN_QUALITY = 0.4;
const START_QUALITY = 0.8;

const photosEl = document.getElementById('photos');
const previewEl = document.getElementById('preview');
const statusArea = document.getElementById('statusArea');
const submitBtn = document.getElementById('submitBtn');
const progressWrap = document.getElementById('progressWrap');
const progressBar = document.getElementById('progressBar');
const form = document.getElementById('businessForm');

let selectedFiles = []; // 원본 File 객체 배열
let optimizedFiles = []; // {name, blob, size, width, height}

function humanFileSize(bytes){
  if (bytes === 0) return '0 B';
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  const sizes = ['B','KB','MB','GB','TB'];
  return (bytes / Math.pow(1024, i)).toFixed( (i===0?0:2) ) + ' ' + sizes[i];
}

// 이미지 압축 함수: 파일 -> Blob
function compressImageFile(file, maxDim = MAX_DIM, targetSize = TARGET_SIZE){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = async () => {
      try{
        let width = img.naturalWidth;
        let height = img.naturalHeight;
        // 리사이즈 비율 계산
        const ratio = Math.min(1, maxDim / Math.max(width, height));
        const newW = Math.round(width * ratio);
        const newH = Math.round(height * ratio);

        // 캔버스에 그리기
        const canvas = document.createElement('canvas');
        canvas.width = newW;
        canvas.height = newH;
        const ctx = canvas.getContext('2d');
        // 배경을 흰색으로 채워 투명 PNG를 JPEG로 변환 시 검은 배경 문제 방지
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, newW, newH);

        // 시도: 여러 품질로 압축 (quality 0.8 -> 0.6 -> 0.5 -> 0.4)
        let q = START_QUALITY;
        let blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', q));
        if(blob.size <= targetSize) {
          URL.revokeObjectURL(url);
          resolve({ blob, width: newW, height: newH, quality: q });
          return;
        }
        // 점진적 감소
        const tries = [0.65, 0.55, 0.45, MIN_QUALITY];
        for(const tq of tries){
          blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', tq));
          if(blob.size <= targetSize) {
            URL.revokeObjectURL(url);
            resolve({ blob, width: newW, height: newH, quality: tq });
            return;
          }
        }
        // 그래도 크면 리턴(최저 품질 blob)
        URL.revokeObjectURL(url);
        resolve({ blob, width: newW, height: newH, quality: MIN_QUALITY });
      } catch(err){
        URL.revokeObjectURL(url);
        reject(err);
      }
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      reject(new Error('이미지 로드 실패'));
    };
    img.src = url;
  });
}

// 파일 선택 처리
photosEl.addEventListener('change', async (e) => {
  selectedFiles = Array.from(e.target.files || []);
  previewEl.innerHTML = '';
  optimizedFiles = [];
  statusArea.textContent = '';

  if(selectedFiles.length === 0) return;

  if(selectedFiles.length > MAX_FILES){
    alert(`최대 ${MAX_FILES}장까지 선택 가능합니다.`);
    photosEl.value = '';
    selectedFiles = [];
    return;
  }

  // 비동기 압축 작업 시작 (고지)
  statusArea.textContent = '이미지 최적화 중... 잠시만 기다려주세요.';
  submitBtn.disabled = true;

  for(const file of selectedFiles){
    // 파일 타입 체크
    if(!file.type.startsWith('image/')){
      alert(`이미지 파일만 업로드 가능합니다: ${file.name}`);
      continue;
    }
    // 압축 시도
    try{
      const res = await compressImageFile(file);
      optimizedFiles.push({
        name: file.name.replace(/\s+/g,'_').replace(/[^\w\-.]/g,''),
        blob: res.blob,
        size: res.blob.size,
        width: res.width,
        height: res.height,
        quality: res.quality
      });

      // 미리보기 카드 추가
      const card = document.createElement('div');
      card.className = 'preview';
      const imgEl = document.createElement('img');
      imgEl.src = URL.createObjectURL(res.blob);
      imgEl.onload = ()=> URL.revokeObjectURL(imgEl.src);
      card.appendChild(imgEl);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        ${file.name}<br/>
        원본: ${humanFileSize(file.size)}<br/>
        최적화: ${humanFileSize(res.blob.size)}<br/>
        ${res.width}×${res.height}px, Q=${res.quality}
      `;
      card.appendChild(meta);
      previewEl.appendChild(card);

    } catch(err){
      console.error('압축 실패', err);
      const warn = document.createElement('div');
      warn.textContent = `압축 실패: ${file.name}`;
      statusArea.appendChild(warn);
    }
  }

  statusArea.textContent = `이미지 최적화 완료 (${optimizedFiles.length}장 준비됨).`;
  submitBtn.disabled = false;
});

// 제출 처리: FormData에 최적화된 이미지를 넣어 XHR로 전송
submitBtn.addEventListener('click', function(){
  (async ()=>{
    // 기본 필드 유효성 체크
    const businessName = document.getElementById('business_name').value.trim();
    const address = document.getElementById('address').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const discount = document.getElementById('discount').value.trim();
    const navermap = document.getElementById('navermap').value.trim();
    const description = document.getElementById('description').value.trim();

    if(!businessName || !address || !phone || !discount || !navermap || !description){
      alert('필수 항목을 모두 입력해 주세요.');
      return;
    }

    // 파일 준비: 선택했지만 최적화가 안 된 경우(예: 브라우저 압축 실패) 대비
    if(selectedFiles.length > 0 && optimizedFiles.length === 0){
      const ok = confirm('이미지 최적화가 준비되지 않았습니다. 원본 이미지를 그대로 업로드하시겠습니까? (권장하지 않습니다)');
      if(!ok) return;
    }

    // FormData 생성
    const fd = new FormData();
    fd.append('업체명', businessName);
    fd.append('주소지', address);
    fd.append('전화번호', phone);
    fd.append('SUT_할인율', discount);
    fd.append('네이버지도링크', navermap);
    fd.append('업체소개', description);
    fd.append('홍보태그', document.getElementById('tags').value || '');

    // _next, _captcha (Formsubmit 사용 규칙)
    fd.append('_next', 'https://google.com');
    fd.append('_captcha','false');

    // 첨부: 최적화된 파일들을 '사진[]'으로 append
    if(optimizedFiles.length > 0){
      for(let i=0;i<optimizedFiles.length;i++){
        const f = optimizedFiles[i];
        // 파일명 중복 방지
        const fileName = `${Date.now()}_${i}_${f.name}`;
        fd.append('사진[]', f.blob, fileName);
      }
    } else {
      // 선택은 했지만 최적화 파일이 없을 경우, 원본 업로드
      for(const f of selectedFiles){
        fd.append('사진[]', f, f.name);
      }
    }

    // 전송
    try{
      submitBtn.disabled = true;
      submitBtn.textContent = '전송 중...';
      progressWrap.style.display = 'block';
      progressBar.style.width = '0%';
      statusArea.textContent = '서버로 전송 중...';

      // XHR 사용(진행률 체크 가능)
      const xhr = new XMLHttpRequest();
      const endpoint = 'https://formsubmit.co/choieuisin@naver.com';
      xhr.open('POST', endpoint, true);
      xhr.upload.onprogress = function(e){
        if(e.lengthComputable){
          const pct = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = pct + '%';
        }
      };
      xhr.onload = function(){
        if(xhr.status >= 200 && xhr.status < 300){
          statusArea.textContent = '제출 완료! 이메일로 접수 내용이 전송되었습니다.';
          progressBar.style.width = '100%';
          // 제출 성공 후 리디렉션이나 초기화
          // 여기서는 간단 알림 후 폼 리셋
          alert('제출이 완료되었습니다. 감사합니다.');
          form.reset();
          previewEl.innerHTML = '';
          optimizedFiles = [];
          selectedFiles = [];
          progressWrap.style.display = 'none';
        } else {
          console.error('전송 실패', xhr.status, xhr.responseText);
          statusArea.textContent = `전송 실패: 서버 응답 ${xhr.status}`;
          alert('전송 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = '제출하기';
      };
      xhr.onerror = function(){
        statusArea.textContent = '전송 오류(네트워크 또는 서버).';
        alert('네트워크 또는 서버 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
        submitBtn.disabled = false;
        submitBtn.textContent = '제출하기';
        progressWrap.style.display = 'none';
      };
      xhr.send(fd);

    } catch(err){
      console.error(err);
      alert('전송 중 오류가 발생했습니다: ' + err.message);
      submitBtn.disabled = false;
      submitBtn.textContent = '제출하기';
      progressWrap.style.display = 'none';
    }
  })();
});
</script>
</body>
</html>
